<!DOCTYPE html>
<html>
<head>
    <title>ESP32 PureSpa</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 10px auto; max-width: 400px; }
        h1 { color: #333; }
        .status-val { font-weight: bold; color: #007bff; }
        .btn-group { display: flex; justify-content: space-around; flex-wrap: wrap; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: bold; color: white; transition: opacity 0.3s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        .btn-on { background-color: #28a745; }
        .btn-off { background-color: #dc3545; }
        .temp-ctrl { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; }
        input[type=number] { padding: 8px; width: 60px; text-align: center; }
        input:disabled { background-color: #eee; }
        .config-box { font-size: 0.8em; color: #666; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ESP32 PureSpa Controller</h1>
    
    <div class='card'>
        <h3>Status</h3>
        <!--<p>Update Method: <span id='update-method' class='status-val'>...</span></p>-->
        <p>Current Time: <span id='current-time' class='status-val'>...</span></p>
        <p>Online: <span id='online' class='status-val'>...</span></p>
        <p>Actual Temp: <span id='act-temp' class='status-val'>--</span> &deg;C</p>
        <p>Target Temp: <span id='set-temp' class='status-val'>--</span> &deg;C</p>
    </div>

    <div class='card'>
        <h3>Schedule</h3>
        <div id="schedule-list" style="text-align: left; margin-bottom: 15px;">
            Loading...
        </div>
        <hr>
        <h4>Add Event</h4>
        <div style="text-align: left; font-size: 0.9em;">
            <div style="margin-bottom: 5px;">
                Type: 
                <select id="sched-type" onchange="toggleSchedType()">
                    <option value="recurring">Recurring</option>
                    <option value="once">Once</option>
                </select>
            </div>
            <div id="div-recurring">
                Days: 
                <label><input type="checkbox" class="sched-dow" value="1">M</label>
                <label><input type="checkbox" class="sched-dow" value="2">T</label>
                <label><input type="checkbox" class="sched-dow" value="3">W</label>
                <label><input type="checkbox" class="sched-dow" value="4">T</label>
                <label><input type="checkbox" class="sched-dow" value="5">F</label>
                <label><input type="checkbox" class="sched-dow" value="6">S</label>
                <label><input type="checkbox" class="sched-dow" value="0">S</label>
            </div>
            <div id="div-once" style="display: none;">
                Date: <input type="date" id="sched-date">
            </div>
            <div style="margin: 5px 0;">
                Time: <input type="time" id="sched-time">
            </div>
            <div style="margin: 5px 0; border-top: 1px solid #eee; pt: 5px;">
                Actions:
                <div><label><input type="checkbox" id="act-power-en"> Power:</label> <select id="act-power-val"><option value="true">ON</option><option value="false">OFF</option></select></div>
                <div><label><input type="checkbox" id="act-filter-en"> Filter:</label> <select id="act-filter-val"><option value="true">ON</option><option value="false">OFF</option></select></div>
                <div><label><input type="checkbox" id="act-heater-en"> Heater:</label> <select id="act-heater-val"><option value="true">ON</option><option value="false">OFF</option></select></div>
                <div><label><input type="checkbox" id="act-bubble-en"> Bubble:</label> <select id="act-bubble-val"><option value="true">ON</option><option value="false">OFF</option></select></div>
                <div><label><input type="checkbox" id="act-temp-en"> Temp:</label> <input type="number" id="act-temp-val" min="20" max="40" value="38" style="width: 50px;"></div>
            </div>
            <button id="btn-add-event" class="btn-on" onclick="addEvent()" style="width: 100%; margin-top: 10px;">Add Scheduled Event</button>
        </div>
    </div>

    <div class='card'>
        <h3>Controls</h3>
        <div class="btn-group">
            <button id="btn-power" onclick="toggle('power')">Power</button>
            <button id="btn-filter" onclick="toggle('filter')">Filter</button>
            <button id="btn-heater" onclick="toggle('heater')">Heater</button>
            <button id="btn-bubble" onclick="toggle('bubble')">Bubble</button>
        </div>
        
        <div class="temp-ctrl">
            <label>Set Temp:</label>
            <input type="number" id="target-temp-input" min="20" max="40">
            <button id="btn-set-temp" class="btn-on" onclick="setTemp()">Set</button>
        </div>
    </div>

    <!--
    <div class="config-box">
        <label><input type="checkbox" id="use-sse" onchange="location.reload()"> Use SSE (instead of Polling)</label>
    </div>
    -->

    <script>
        // CONFIGURATION
        const useSSE = false;
        /*const useSSE = localStorage.getItem('useSSE') === 'true';
        document.getElementById('use-sse').checked = useSSE;
        document.getElementById('update-method').innerText = useSSE ? 'SSE' : 'Polling (2s)';*/

        // UI Logic
        function updateUI(data) {
            const isOnline = data.online;
            const isPowerOn = isOnline ? data.power : false;

            document.getElementById('online').innerText = isOnline ? 'Yes' : 'No';
            document.getElementById('act-temp').innerText = (isOnline && data.act_temp != -99) ? data.act_temp : '--';
            document.getElementById('set-temp').innerText = (isPowerOn && data.set_temp != -99) ? data.set_temp : '--';
            document.getElementById('current-time').innerText = data.time || '...';
            
            // Power button is only enabled if the controller is ONLINE
            updateButton('btn-power', isPowerOn, !isOnline);
            
            // Other buttons are only enabled if Online AND Power is ON
            updateButton('btn-filter', isPowerOn ? data.filter : false, !isPowerOn);
            updateButton('btn-heater', isPowerOn ? data.heater : false, !isPowerOn);
            updateButton('btn-bubble', isPowerOn ? data.bubble : false, !isPowerOn);
            
            // Temperature controls
            document.getElementById('target-temp-input').disabled = !isPowerOn;
            document.getElementById('btn-set-temp').disabled = !isPowerOn;
            
            if (isPowerOn && data.set_temp != -99 && document.getElementById('target-temp-input').value === "") {
                document.getElementById('target-temp-input').value = data.set_temp;
            }
        }

        // Schedule Logic
        function toggleSchedType() {
            const type = document.getElementById('sched-type').value;
            document.getElementById('div-recurring').style.display = type === 'recurring' ? 'block' : 'none';
            document.getElementById('div-once').style.display = type === 'once' ? 'block' : 'none';
        }

        async function fetchSchedule() {
            try {
                const r = await fetch('/api/schedule');
                const events = await r.json();
                const list = document.getElementById('schedule-list');
                if (events.length === 0) {
                    list.innerHTML = '<i>No events scheduled.</i>';
                } else {
                    let html = '';
                    const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                    events.forEach(ev => {
                        let when = '';
                        if (ev.recurring) {
                            let activeDays = [];
                            for(let i=0; i<7; i++) if (ev.dow & (1 << i)) activeDays.push(days[i]);
                            when = 'Every ' + activeDays.join(',');
                        } else {
                            when = `${ev.year}-${ev.month}-${ev.day}`;
                        }
                        const time = `${ev.hour.toString().padStart(2, '0')}:${ev.minute.toString().padStart(2, '0')}`;
                        
                        let actions = [];
                        if (ev.setPower) actions.push('Power ' + (ev.powerValue ? 'ON' : 'OFF'));
                        if (ev.setFilter) actions.push('Filter ' + (ev.filterValue ? 'ON' : 'OFF'));
                        if (ev.setHeater) actions.push('Heater ' + (ev.heaterValue ? 'ON' : 'OFF'));
                        if (ev.setBubble) actions.push('Bubble ' + (ev.bubbleValue ? 'ON' : 'OFF'));
                        if (ev.setTemp) actions.push('Temp ' + ev.tempValue + 'Â°C');

                        html += `<div style="border: 1px solid #ddd; padding: 5px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; ${ev.enabled ? '' : 'opacity: 0.5;'}">
                            <div>
                                <b>${time}</b> [${when}]<br>
                                <small>${actions.join(', ')}</small>
                            </div>
                            <div>
                                <input type="checkbox" ${ev.enabled ? 'checked' : ''} onchange="toggleEvent(${ev.id}, this.checked)">
                                <button onclick="deleteEvent(${ev.id})" style="background: #dc3545; padding: 2px 5px; margin: 0 0 0 5px; font-size: 0.8em;">X</button>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                }

                // Limit check
                const btn = document.getElementById('btn-add-event');
                if (events.length >= 10) {
                    btn.disabled = true;
                    btn.innerText = 'Limit Reached (Max 10)';
                    btn.style.opacity = '0.5';
                } else {
                    btn.disabled = false;
                    btn.innerText = 'Add Scheduled Event';
                    btn.style.opacity = '1';
                }
            } catch (e) { console.error(e); }
        }

        async function addEvent() {
            const type = document.getElementById('sched-type').value;
            const time = document.getElementById('sched-time').value;
            if (!time) return alert('Please set a time');
            const [hour, minute] = time.split(':').map(Number);
            
            const ev = {
                recurring: type === 'recurring',
                hour: hour,
                minute: minute,
                setPower: document.getElementById('act-power-en').checked,
                powerValue: document.getElementById('act-power-val').value === 'true',
                setFilter: document.getElementById('act-filter-en').checked,
                filterValue: document.getElementById('act-filter-val').value === 'true',
                setHeater: document.getElementById('act-heater-en').checked,
                heaterValue: document.getElementById('act-heater-val').value === 'true',
                setBubble: document.getElementById('act-bubble-en').checked,
                bubbleValue: document.getElementById('act-bubble-val').value === 'true',
                setTemp: document.getElementById('act-temp-en').checked,
                tempValue: parseInt(document.getElementById('act-temp-val').value)
            };

            if (ev.recurring) {
                let mask = 0;
                document.querySelectorAll('.sched-dow:checked').forEach(cb => mask |= (1 << parseInt(cb.value)));
                if (mask === 0) return alert('Please select at least one day');
                ev.dow = mask;
            } else {
                const date = document.getElementById('sched-date').value;
                if (!date) return alert('Please select a date');
                const [y, m, d] = date.split('-').map(Number);
                ev.year = y; ev.month = m; ev.day = d;
            }

            await fetch('/api/schedule/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ev)
            });
            fetchSchedule();
        }

        async function deleteEvent(id) {
            if (!confirm('Delete this event?')) return;
            await fetch('/api/schedule/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            fetchSchedule();
        }

        async function toggleEvent(id, enabled) {
            await fetch('/api/schedule/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, enabled: enabled })
            });
            fetchSchedule();
        }

        fetchSchedule();

        function updateButton(id, isActive, forceDisabled) {
            const btn = document.getElementById(id);
            const cmd = id.split('-')[1];
            const label = cmd.charAt(0).toUpperCase() + cmd.slice(1);

            if (isActive) {
                btn.className = 'btn-on';
                btn.innerText = label + ' ON';
            } else {
                btn.className = 'btn-off';
                btn.innerText = label + ' OFF';
            }
            
            btn.disabled = forceDisabled;
            btn.onclick = forceDisabled ? null : () => toggle(cmd, !isActive);
        }

        // Control Logic
        function toggle(cmd, value) {
            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cmd: cmd, value: value })
            });
        }

        function setTemp() {
            const val = parseInt(document.getElementById('target-temp-input').value);
            toggle('temp', val);
        }

        // Update Logic (SSE or Polling)
        if (useSSE) {
            const eventSource = new EventSource('//' + location.hostname + ':81/api/sse');
            eventSource.onmessage = function(event) {
                updateUI(JSON.parse(event.data));
            };
            eventSource.onerror = function(err) {
                console.error('SSE Error:', err);
            };
        } else {
            function pollStatus() {
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => updateUI(data))
                    .catch(e => {
                        console.error('Polling error:', e);
                        // If fetching fails, show offline
                        updateUI({ online: false, power: false });
                    })
                    .finally(() => setTimeout(pollStatus, 2000));
            }
            pollStatus();
        }

        // Settings toggle
        document.getElementById('use-sse').addEventListener('change', (e) => {
            localStorage.setItem('useSSE', e.target.checked);
        });
    </script>
</body>
</html>
